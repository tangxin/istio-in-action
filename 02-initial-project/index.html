<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="初始化第一个项目 #   项目代码在 https://github.com/tangx/istio-in-action 命令中有很多快捷键， 参考 install and prepare  1. 创建 namespace 并开启整体 istio 注入 #  1.1 创建 namespace myistio #  kc ns myistio namespace/myistio created kns myistio Context &#34;default&#34; modified. Active namespace is &#34;myistio&#34;. 1.2 向 namespace 中开启 istio 注入 #  # 向 ns 加入标签 istio-injection=enabled ， 开启注入 kubectl label namespace myistio istio-injection=enabled namespace/myistio labeleds # 查看具有 istio-injection 标签的 ns kgall ns -L istio-injection NAME STATUS AGE ISTIO-INJECTION kube-system Active 42d kube-public Active 42d istio-system Active 10m myistio Active 11s enabled default Active 42d 2."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content><meta property="og:description" content="初始化第一个项目 #   项目代码在 https://github.com/tangx/istio-in-action 命令中有很多快捷键， 参考 install and prepare  1. 创建 namespace 并开启整体 istio 注入 #  1.1 创建 namespace myistio #  kc ns myistio namespace/myistio created kns myistio Context &#34;default&#34; modified. Active namespace is &#34;myistio&#34;. 1.2 向 namespace 中开启 istio 注入 #  # 向 ns 加入标签 istio-injection=enabled ， 开启注入 kubectl label namespace myistio istio-injection=enabled namespace/myistio labeleds # 查看具有 istio-injection 标签的 ns kgall ns -L istio-injection NAME STATUS AGE ISTIO-INJECTION kube-system Active 42d kube-public Active 42d istio-system Active 10m myistio Active 11s enabled default Active 42d 2."><meta property="og:type" content="article"><meta property="og:url" content="https://books.tangx.in/istio-in-action/02-initial-project/"><meta property="article:section" content><title>02 Initial Project | kuberbuilder 从零开始</title><link rel=manifest href=/istio-in-action/manifest.json><link rel=icon href=/istio-in-action/favicon.png type=image/x-icon><link rel=stylesheet href=/istio-in-action/book.min.958cea7827621d6fbcb3acf091344c3e44e3d2a9428f9c3c38bb9eb37bf8c45d.css integrity="sha256-lYzqeCdiHW+8s6zwkTRMPkTj0qlCj5w8OLues3v4xF0=" crossorigin=anonymous><script defer src=/istio-in-action/flexsearch.min.js></script><script defer src=/istio-in-action/en.search.min.adb51cd47feaf600848d6f5cb6f26433673ebe5ba51856091c25785042123ebb.js integrity="sha256-rbUc1H/q9gCEjW9ctvJkM2c+vlulGFYJHCV4UEISPrs=" crossorigin=anonymous></script><script defer src=/istio-in-action/sw.min.0c0c83d52036acf50f5c3f746a95875059c3e28084dea729d49b09123db8d2ee.js integrity="sha256-DAyD1SA2rPUPXD90apWHUFnD4oCE3qcp1JsJEj240u4=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/istio-in-action/><img src=/istio-in-action/logo.png alt=Logo><span>kuberbuilder 从零开始</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><h1 id=目录>目录
<a class=anchor href=#%e7%9b%ae%e5%bd%95>#</a></h1><h2 id=环境准备>环境准备
<a class=anchor href=#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87>#</a></h2><ol><li><a href=/istio-in-action/01-install/>安装 docker, k3s, istio 环境</a></li><li><a href=/istio-in-action/02-initial-project/ class=active>初始化第一个项目 - prod</a></li><li><a href=/istio-in-action/07-upgrade-project/>升级项目 - prod and review</a></li><li><a href=/istio-in-action/16-lego-create-server-certificate/>使用 lego 创建 https 证书</a></li></ol><h2 id=virtualservice>VirtualService
<a class=anchor href=#virtualservice>#</a></h2><ol start=3><li><a href=/istio-in-action/03-vs-and-ingress/>istio VirtualService 和 k8s Ingress</a></li><li><a href=/istio-in-action/04-gateway/>创建 Gateway 允许外部访问</a></li><li><a href=/istio-in-action/05-vs-http-rewrite-by-uri/>VirtualService 给予 uri 重写路由</a></li><li><a href=/istio-in-action/06-dr-subset/>使用 DestinationRule Subset 进行路由分组(版本控制)</a></li><li><a href=/istio-in-action/08-vs-http-rewrite-by-header/>VirtualService 基于 Header 重写路由</a></li><li>VirtualService 支持重写路由的所有方式</li><li><a href=/istio-in-action/10-vs-http-redirect/>VirtualService 路由重定向</a></li><li><a href=/istio-in-action/11-vs-http-retry/>VirtualService 的重试机制</a></li><li><a href=/istio-in-action/12-vs-http-fault-injection/>VirtualService 注入错误实现混沌测试</a></li><li>VirtualService 委托: 测试失败</li><li><a href=/istio-in-action/14-vs-http-header-operation/>VirtualService Header 管理</a></li><li>VirutalService 根据客户端 Label 转发路由(sourceLabels): 待测试</li><li><a href=/istio-in-action/17-gw-https-support-standard/>Gateway 支持 https 访问 - 标准模式</a></li><li><a href=/istio-in-action/18-dr-simple-loadbalance/>使用 DestionationRule 流量控制策略 - 简单负载均衡</a></li></ol></nav><script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/istio-in-action/svg/menu.svg class=book-icon alt=Menu></label>
<strong>02 Initial Project</strong>
<label for=toc-control><img src=/istio-in-action/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#1-创建-namespace-并开启整体-istio-注入>1. 创建 namespace 并开启整体 istio 注入</a><ul><li><a href=#11-创建-namespace-myistio>1.1 创建 namespace myistio</a></li><li><a href=#12-向-namespace-中开启-istio-注入>1.2 向 namespace 中开启 istio 注入</a></li></ul></li><li><a href=#2-创建第一个项目>2. 创建第一个项目</a><ul><li><a href=#21-程序说明>2.1 程序说明</a></li></ul></li><li><a href=#3-简单测试>3. 简单测试</a></li></ul></nav></aside></header><article class=markdown><h1 id=初始化第一个项目>初始化第一个项目
<a class=anchor href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e7%ac%ac%e4%b8%80%e4%b8%aa%e9%a1%b9%e7%9b%ae>#</a></h1><ol><li>项目代码在 <code>https://github.com/tangx/istio-in-action</code></li><li>命令中有很多快捷键， 参考
<a href=/istio-in-action/01-install/>install and prepare</a></li></ol><h2 id=1-创建-namespace-并开启整体-istio-注入>1. 创建 namespace 并开启整体 istio 注入
<a class=anchor href=#1-%e5%88%9b%e5%bb%ba-namespace-%e5%b9%b6%e5%bc%80%e5%90%af%e6%95%b4%e4%bd%93-istio-%e6%b3%a8%e5%85%a5>#</a></h2><h3 id=11-创建-namespace-myistio>1.1 创建 namespace myistio
<a class=anchor href=#11-%e5%88%9b%e5%bb%ba-namespace-myistio>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kc ns myistio
    namespace/myistio created

kns myistio
    Context <span style=color:#e6db74>&#34;default&#34;</span> modified.
    Active namespace is <span style=color:#e6db74>&#34;myistio&#34;</span>.
</code></pre></div><h3 id=12-向-namespace-中开启-istio-注入>1.2 向 namespace 中开启 istio 注入
<a class=anchor href=#12-%e5%90%91-namespace-%e4%b8%ad%e5%bc%80%e5%90%af-istio-%e6%b3%a8%e5%85%a5>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 向 ns 加入标签 istio-injection=enabled ， 开启注入</span>
kubectl label namespace myistio istio-injection<span style=color:#f92672>=</span>enabled
    namespace/myistio labeleds


<span style=color:#75715e># 查看具有 istio-injection 标签的 ns</span>
kgall ns -L istio-injection
    NAME              STATUS   AGE   ISTIO-INJECTION
    kube-system       Active   42d
    kube-public       Active   42d
    istio-system      Active   10m
    myistio           Active   11s   enabled
    default           Active   42d
</code></pre></div><h2 id=2-创建第一个项目>2. 创建第一个项目
<a class=anchor href=#2-%e5%88%9b%e5%bb%ba%e7%ac%ac%e4%b8%80%e4%b8%aa%e9%a1%b9%e7%9b%ae>#</a></h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>.
<span style=color:#960050;background-color:#1e0010>├──</span> <span style=color:#a6e22e>cmd</span>
<span style=color:#960050;background-color:#1e0010>│</span>   <span style=color:#960050;background-color:#1e0010>└──</span> <span style=color:#a6e22e>prod</span>   <span style=color:#75715e>// 项目名称
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>├──</span> <span style=color:#a6e22e>dockerfiles</span>  <span style=color:#75715e>// 编译镜像使用的 dockerfile
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>├──</span> <span style=color:#a6e22e>scripts</span>
<span style=color:#960050;background-color:#1e0010>│</span>   <span style=color:#960050;background-color:#1e0010>└──</span> <span style=color:#a6e22e>deployment</span>  <span style=color:#75715e>// k8s 发布时用的 yaml 文件。 通过渲染发布
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>├──</span> .<span style=color:#a6e22e>version</span>  <span style=color:#75715e>// 版本编号管理
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>└──</span> <span style=color:#a6e22e>version</span>   <span style=color:#75715e>// go 程序版本注入
</span></code></pre></div><h3 id=21-程序说明>2.1 程序说明
<a class=anchor href=#21-%e7%a8%8b%e5%ba%8f%e8%af%b4%e6%98%8e>#</a></h3><p>程序功能很简单， 就是在请求地址 <strong>http://servername/prod/list</strong> 是返回一个固定结果, 如下。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;data&#34;</span>: {
    <span style=color:#f92672>&#34;Name&#34;</span>: <span style=color:#e6db74>&#34;istio in action&#34;</span>,
    <span style=color:#f92672>&#34;Price&#34;</span>: <span style=color:#ae81ff>300</span>,
    <span style=color:#f92672>&#34;Reviews&#34;</span>: <span style=color:#66d9ef>null</span>
  },
  <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;v1.0.0&#34;</span>
}
</code></pre></div><ol><li>data 的值是在 gin handler 中固定写死的。 <code>/cmd/prod/main.go</code></li><li>version 是通过 <code>/version/version.go</code> 在编译时注入的， 其值来源于文件 <code>.version</code>。</li></ol><p>使用如下命令进行编译发布</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make apply.docker
</code></pre></div><h2 id=3-简单测试>3. 简单测试
<a class=anchor href=#3-%e7%ae%80%e5%8d%95%e6%b5%8b%e8%af%95>#</a></h2><p>在 myistio namespace 下创建一个容器， 作为客户端。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ksn myistio
k create deployment toolbox --image<span style=color:#f92672>=</span>nginx:alpine
</code></pre></div><p>进入创建的工具容器， 使用 curl 调用 prod 服务。 确认调用无异常。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>keti toolbox-77889d56fd-dnfbz sh
    kubectl exec <span style=color:#f92672>[</span>POD<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>COMMAND<span style=color:#f92672>]</span> is DEPRECATED and will be removed in a future version. Use kubectl exec <span style=color:#f92672>[</span>POD<span style=color:#f92672>]</span> -- <span style=color:#f92672>[</span>COMMAND<span style=color:#f92672>]</span> instead.

curl svc-prod/prods/list
    <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;data&#34;</span>:<span style=color:#f92672>{</span><span style=color:#e6db74>&#34;Name&#34;</span>:<span style=color:#e6db74>&#34;istio in action&#34;</span>,<span style=color:#e6db74>&#34;Price&#34;</span>:300,<span style=color:#e6db74>&#34;Reviews&#34;</span>:null<span style=color:#f92672>}</span>,<span style=color:#e6db74>&#34;version&#34;</span>:<span style=color:#e6db74>&#34;v1.0.0&#34;</span><span style=color:#f92672>}</span>
</code></pre></div></article><div class="book-footer justify-between"></div><hr style=height:1px;background:var(--gray-200)><br><p>本图书由<a href=https://github.com/tangx>老麦</a>©2021 版权所有，<a href=https://github.com/tangx/kubebuilder-zero-to-one>所有文章</a>采用<a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh>知识署名-非商业性使用-禁止演绎 4.0 国际</a>进行许可。</p><div style=text-align:center><p><img width=70% style=width:70%;height:70%;!important src=https://tangx.in/assets/images/wx-qrcode.png></p></div><script src=https://utteranc.es/client.js repo=tangx/tangx.github.io issue-term=title theme=github-light crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/tangx/kubebuilder-zero-to-one/edit/master/./02-initial-project.md target=_blank rel=noopener><img src=/istio-in-action/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#1-创建-namespace-并开启整体-istio-注入>1. 创建 namespace 并开启整体 istio 注入</a><ul><li><a href=#11-创建-namespace-myistio>1.1 创建 namespace myistio</a></li><li><a href=#12-向-namespace-中开启-istio-注入>1.2 向 namespace 中开启 istio 注入</a></li></ul></li><li><a href=#2-创建第一个项目>2. 创建第一个项目</a><ul><li><a href=#21-程序说明>2.1 程序说明</a></li></ul></li><li><a href=#3-简单测试>3. 简单测试</a></li></ul></nav></div></aside></main></body></html>